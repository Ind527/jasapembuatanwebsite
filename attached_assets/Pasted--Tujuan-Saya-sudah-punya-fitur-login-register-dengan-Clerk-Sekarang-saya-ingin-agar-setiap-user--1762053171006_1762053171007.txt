ðŸ’¡ Tujuan:
Saya sudah punya fitur login/register dengan Clerk. Sekarang saya ingin agar setiap user yang login atau register otomatis disimpan ke backend (Express.js) di Replit. Backend ini juga menyimpan role (sales atau admin).

ðŸ§© Stack yang digunakan:
- Frontend: React + Clerk
- Backend: Node.js + Express.js
- Database: MongoDB (Mongoose)
- Clerk SDK untuk verifikasi token

ðŸŽ¯ Fitur yang harus dibuat:
1. Endpoint POST /api/users/sync
   - Menerima data dari frontend setelah user login via Clerk
   - Menyimpan atau memperbarui data user di database MongoDB
   - Data disimpan: clerkId, email, name, role, createdAt

2. Middleware autentikasi `verifyClerkToken`
   - Verifikasi token dari Clerk sebelum izinkan simpan data

3. Role â€œadminâ€ diberikan otomatis untuk email `sultancisoka@gmail.com`
   - Selain itu dianggap â€œsalesâ€

4. Backend menyimpan user di MongoDB (gunakan variabel MONGO_URI dari Secrets)

ðŸªª Environment Variables:
CLERK_SECRET_KEY=sk_live_xxx
MONGO_URI=mongodb+srv://...
PORT=5000

ðŸ§± Struktur Folder:
.
â”œâ”€â”€ server.js
â”œâ”€â”€ models/
â”‚   â””â”€â”€ User.js
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ users.js
â””â”€â”€ middleware/
    â””â”€â”€ auth.js

ðŸ“„ Isi file:

ðŸ‘‰ models/User.js
```js
const mongoose = require("mongoose");

const userSchema = new mongoose.Schema({
  clerkId: String,
  email: String,
  name: String,
  role: { type: String, enum: ["sales", "admin"], default: "sales" },
  createdAt: { type: Date, default: Date.now },
});

module.exports = mongoose.model("User", userSchema);
ðŸ‘‰ middleware/auth.js
import { getAuth } from "@clerk/clerk-sdk-node";

export const verifyClerkToken = async (req, res, next) => {
  try {
    const auth = getAuth(req);
    if (!auth || !auth.userId) {
      return res.status(401).json({ message: "Unauthorized" });
    }
    req.userId = auth.userId;
    next();
  } catch (err) {
    res.status(401).json({ message: "Invalid token" });
  }
};
ðŸ‘‰ routes/users.js
const express = require("express");
const router = express.Router();
const User = require("../models/User");

router.post("/sync", async (req, res) => {
  try {
    const { clerkId, email, name } = req.body;

    const role = email === "sultancisoka@gmail.com" ? "admin" : "sales";

    let user = await User.findOne({ clerkId });
    if (!user) {
      user = new User({ clerkId, email, name, role });
      await user.save();
    } else {
      user.email = email;
      user.name = name;
      user.role = role;
      await user.save();
    }

    res.json({ message: "User synced", user });
  } catch (error) {
    res.status(500).json({ message: "Error syncing user", error });
  }
});

module.exports = router;
ðŸ‘‰ server.js
const express = require("express");
const mongoose = require("mongoose");
const bodyParser = require("body-parser");
const cors = require("cors");
const usersRoute = require("./routes/users");

const app = express();

app.use(cors());
app.use(bodyParser.json());

mongoose.connect(process.env.MONGO_URI)
  .then(() => console.log("âœ… MongoDB Connected"))
  .catch(err => console.error("MongoDB Error:", err));

app.use("/api/users", usersRoute);

app.listen(process.env.PORT || 5000, () => {
  console.log(`ðŸš€ Server running on port ${process.env.PORT || 5000}`);
});
ðŸ‘‰ frontend (React) â€“ tambahkan di useEffect setelah user login:
import { useUser } from "@clerk/clerk-react";
import { useEffect } from "react";

function SyncUser() {
  const { user } = useUser();

  useEffect(() => {
    if (user) {
      fetch("https://your-backend-url/api/users/sync", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          clerkId: user.id,
          email: user.primaryEmailAddress.emailAddress,
          name: user.fullName,
        }),
      });
    }
  }, [user]);
}

export default SyncUser;